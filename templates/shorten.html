{% extends "base.html" %}
{% block header %}
    <script src="https://unpkg.com/axios@0.16.2/dist/axios.min.js"></script>
{% endblock %}
{% block nav %}
    {% include "nav_for_login.html" %}
{% endblock %}
{% block content %}
    <h1>shorten</h1>
    <div class="columns" id="app">
        <div class="column is-two-thirds">
            <div class="select">
                <select id="domain">
                    {% for d in domain_settings %}
                        <option value="{{ d }}" {% if loop.index0 == 0 %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field">
                <label class="label">Url to shorten</label>
                <div class="control">
                    <textarea class="textarea" placeholder="Long URL" name="long_url" id="long_url"></textarea>
                    <p class="help is-danger" id="shorten-error-message"></p>
                    <a class="button is-small" id="submit-shorten">Shorten</a>
                    <div class="spinner" style="visibility: hidden">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                    </div>
                </div>
            </div>
            <div style="visibility: hidden" id="result">
                <h2>result</h2>
                <div class="tags has-addons">
                    <span class="tag is-medium" id="short_url"></span>

                    <span class="tag is-primary" id="copy-short_url">copy</span><span class="copy-status">&nbsp;</span>
                </div>
                <article class="media" style="visibility: hidden" id="result-card">
                    <figure class="media-left">
                        <p class="image is-64x64">
                            <img src="http://bulma.io/images/placeholders/128x128.png" id="result-image">
                        </p>
                    </figure>
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong id="result-title"></strong>
                                <br>
                                <span id="result-description"></span>
                            </p>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-three-quarters" id="short_urls">

        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        var pasteTarget = document.querySelector('#long_url');
        pasteTarget.addEventListener('paste', shortenClipboard, false);
        var shortnButtonTarget = document.querySelector('#submit-shorten');
        shortnButtonTarget.addEventListener('click', shortenButton, false);
        var copyButtonTarget = document.querySelector('#copy-short_url');
        copyButtonTarget.addEventListener('click', copyShortUrl, false);

        function editShortURL(event) {
            event.preventDefault();
            this.focus();
        }

        function shortenButton() {
            var longURL = document.querySelector('#long_url').value;
            shorten(longURL);
        }

        function shortenClipboard(e) {
            var longURL = e.clipboardData.getData('Text');
            shorten(longURL);
        }

        function onEnterKey(element, event) {
            var charCode = (typeof event.which === "number") ? event.which : event.keyCode;
            if (charCode == 13) {
                event.preventDefault();
                postShortURL(element);
            }
        }

        function postShortURL(element) {
            var longURL = element.closest('a').href;
            var domain = element.previousElementSibling.innerText;
            var customPath = element.innerText;
            axios.post('/api/v1/shorten', {'domain': domain, 'url': longURL, 'custom_path': customPath})
                .then(function (response) {
                    console.log('Request succeeded with JSON response', response);
                    if (response.data.warning !== null) {
                        element.nextElementSibling.innerText = 'x';
                        element.focus();
                    } else {
                        element.nextElementSibling.innerHTML = '&#10004;';
                        element.blur();
                    }
                })
                .catch(function (error) {
                    console.log(error);
                    element.nextElementSibling.insertAdjacentHTML('afterend', '<p class="help is-danger">' + error.response.data.errors.join() + '</p>');
                    element.focus();
                });
        }

        function shorten(longURL) {
            var domainElement = document.querySelector('#domain');
            var domain = domainElement.options[domainElement.selectedIndex].value;
            document.querySelector('div.spinner').setAttribute('style', 'visibility: visible');
            axios.post('/api/v1/shorten', {'domain': domain, 'url': longURL})
                .then(function (response) {
                    console.log('Request succeeded with JSON response', response);
                    document.querySelector('#shorten-error-message').innerText = '';
                    document.querySelector('#short_url').innerHTML =
                        '<a href="' + longURL + '"><strong><span class="domain">' + response.data.short_url.split('/')[0] + '</span>'
                        + '/<span class="path" contentEditable="true" onkeypress="onEnterKey(this, event)">' + response.data.short_url.split('/')[1] + '</span></strong></a>';
                    document.querySelector("#short_url span.path").addEventListener('click', editShortURL, false);
                    document.querySelector('#result').setAttribute('style', 'visibility: visible');
                    if (response.data.warning !== null) {
                        document.querySelector('#shorten-error-message').innerText = response.data.warning;
                        document.querySelector('#result-card').setAttribute('style', 'visibility: hidden');
                    } else {
                        document.querySelector('#result-title').innerText = response.data.title;
                        document.querySelector('#result-description').innerText = response.data.description;
                        document.querySelector('#result-image').setAttribute('src', response.data.image);
                        document.querySelector('#result-card').setAttribute('style', 'visibility: visible');
                    }
                    document.querySelector('div.spinner').setAttribute('style', 'visibility: hidden');
                })
                .catch(function (error) {
                    console.log(error);
                    document.querySelector('#shorten-error-message').innerText = error.response.data.errors.join();
                    document.querySelector('div.spinner').setAttribute('style', 'visibility: hidden');
                });
        }

        function copyShortUrl() {
            var shortURL = document.querySelector('#short_url span.domain').innerText + '/' + document.querySelector('#short_url span.path').innerText;
            var copyResult = copyToClipboard(shortURL);
            if (copyResult) {
                document.querySelector('span.copy-status').innerHTML = '&#10004;';
                setTimeout(function () {
                    document.querySelector('span.copy-status').innerHTML = '&nbsp;';
                }, 10000);
            }
        }

        // from http://www.jomendez.com/2017/01/25/copy-clipboard-using-javascript/
        function copyToClipboard(text) {

            if (window.clipboardData && window.clipboardData.setData) {
                // IE specific code path to prevent textarea being shown while dialog is visible.

                return clipboardData.setData("Text", text);

            }

            else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
                var textarea = document.createElement("textarea");
                textarea.textContent = text;
                textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in MS Edge.
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    return document.execCommand("copy"); // Security exception may be thrown by some browsers.
                } catch (ex) {
                    console.warn("Copy to clipboard failed.", ex);
                    return false;
                } finally {
                    document.body.removeChild(textarea);
                }
            }
        }

        var mediaObjTemplate = `
        <div class="box">
          <article class="media">
            <div class="media-left">
              <figure class="image is-64x64">
                <img src="@@image" alt="Image"></a>
              </figure>
            </div>
            <div class="media-content">
              <div class="content" data-shorturl="@@short_url_domain/@@short_url_path">
                <p>
                  <a href="@@long_url"><strong><span class="domain">@@short_url_domain</span>/<span class="path" contentEditable="true" onkeypress="onEnterKey(this, event)">@@short_url_path</span></strong></a>
                  <br/>
                  <small>@@title</small>
                  <br/>
                  @@description
                </p>
                <p>
                    <div class="field has-addons">
                      <div class="control">
                        <input class="input is-small" type="text" placeholder="input a tag" name="tag">
                      </div>
                      <div class="control">
                        <button class="button is-small addtag">
                          Add Tag +
                        </button>
                      </div>
                    </div>
                    <p class="tagline"></p>
                </p>
                <p><a href="/page/detail/@@id"><u>check detail data</u></a></p>
              </div>
            </div>
            <div class="media-right">
              <button class="delete"></button>
            </div>
          </article>
        </div>
        `

        function deleteShortURL(event) {
            const that = this.parentElement.parentElement;
            const domain = that.querySelector('span.domain').innerText;
            const path = that.querySelector('span.path').innerText;
            const shortURL = domain + '/' + path;
            if (confirm("delete this short url?") == true) {
                this.parentElement.parentElement.parentElement.remove();
                axios.delete('/api/v1/short_urls/' + shortURL)
                    .then(function (response) {
                        console.log('delete failed');
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
        }

        function addTag(event){
            const that = this.parentElement.parentElement;
            const tag = that.querySelector('input.input');
            const tagValue = tag.value.trim();
            var duplication = false;
            if (tagValue != "") {
               that.parentElement.querySelector('p.tagline').querySelectorAll('span.tag').forEach(function(val, index){
                   if(val.innerText == tagValue){
                       duplication = true;
                   }
               });
               if(duplication === false) {
                   const shortURL = that.parentElement.dataset.shorturl;
                   axios.patch('/api/v1/short_urls/'+shortURL+'/update', {'tag': tagValue})
                       .then(function (response){
                           that.parentElement.querySelector('p.tagline').insertAdjacentHTML("beforeend", '<span class="tag is-link">' + tagValue + '<button class="delete is-small"></button></span>&nbsp;');
                       })
                       .catch(function (error) {
                           console.log(error);
                       });
               }
               tag.value = "";
            }
        }

        axios.get('/api/v1/short_urls')
            .then(function (response) {
                var resultsHTML = "<h2>Your short urls</h2>";
                response.data.results.forEach(function (val, index) {
                    var shortURLDomain = val.short_url !== null ? val.short_url.split('/')[0] : "";
                    var shortURLPath = val.short_url !== null ? val.short_url.split('/')[1] : "";
                    resultsHTML += mediaObjTemplate.replace(/@@image/g, val.image)
                        .replace(/@@title/g, val.title)
                        .replace(/@@short_url_domain/g, shortURLDomain)
                        .replace(/@@short_url_path/g, shortURLPath)
                        .replace(/@@long_url/g, val.long_url)
                        .replace(/@@description/g, val.description)
                        .replace(/@@id/g, val.id);
                });
                document.querySelector('#short_urls').innerHTML = resultsHTML;
                document.querySelectorAll('span.path').forEach(function (element) {
                    element.addEventListener('click', editShortURL, false);
                });
                document.querySelectorAll('button.addtag').forEach(function (element) {
                    element.addEventListener('click', addTag, false);
                });
                document.querySelectorAll('button.delete').forEach(function (element) {
                    element.addEventListener('click', deleteShortURL, false);
                });
            })
            .catch(function (error) {
                console.log(error);
                document.querySelector('#short_urls').innerHTML = error.response.data.errors.join();
            });
    </script>
{% endblock %}