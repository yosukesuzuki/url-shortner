{% extends "base.html" %}
{% block header %}
{% endblock %}
{% block nav %}
    {% include "nav_for_login.html" %}
{% endblock %}
{% block content %}
    <h1>shorten</h1>
    <div class="columns" id="app">
        <div class="column is-two-thirds">
            <div class="select">
                <select id="domain">
                    {% for d in domain_settings %}
                        <option value="{{ d }}" {% if loop.index0 == 0 %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field">
                <label class="label">Url to shorten</label>
                <div class="control">
                    <textarea class="textarea" placeholder="Long URL" name="long_url" id="long_url"></textarea>
                </div>
            </div>
            <div style="visibility: hidden" id="result">
                <h2>result</h2>
                <div class="tags has-addons">
                    <span class="tag" id="short_url"></span>
                    <span class="tag is-primary">copy</span>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        var pasteTarget = document.querySelector('#long_url');
        pasteTarget.addEventListener('paste', function (e) {
            var long_url = e.clipboardData.getData('Text');
            var domainElement = document.querySelector('#domain');
            var domain = domainElement.options[domainElement.selectedIndex].value;
            fetch('/func/shorten', {
                method: 'post',
                credentials: 'same-origin',
                headers: {
                    'Content-type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                body: 'url=' + encodeURI(long_url) + '&domain=' + encodeURI(domain)
            })
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    console.log('Request succeeded with JSON response', data);
                    document.querySelector('#short_url').innerText = data.short_url;
                    document.querySelector('#result').setAttribute('style', 'visibility: visible');
                })
                .catch(function (error) {
                    console.log('Request failed', error);
                });
        }, false);

    </script>
{% endblock %}