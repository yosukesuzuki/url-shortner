{% extends "base.html" %}
{% block header %}
    <script src="https://unpkg.com/axios@0.16.2/dist/axios.min.js"></script>
{% endblock %}
{% block nav %}
    {% include "nav_for_login.html" %}
{% endblock %}
{% block content %}
    <h1>shorten</h1>
    <div class="columns" id="app">
        <div class="column is-two-thirds">
            <div class="select">
                <select id="domain">
                    {% for d in domain_settings %}
                        <option value="{{ d }}" {% if loop.index0 == 0 %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field">
                <label class="label">Url to shorten</label>
                <div class="control">
                    <textarea class="textarea" placeholder="Long URL" name="long_url" id="long_url"></textarea>
                    <p class="help is-danger" id="shorten-error-message"></p>
                    <a class="button is-small" id="submit-shorten">Shorten</a>
                    <div class="spinner" style="visibility: hidden">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                    </div>
                </div>
            </div>
            <div style="visibility: hidden" id="result">
                <h2>result</h2>
                <div class="tags has-addons">
                    <span class="tag" id="short_url"></span>
                    <span class="tag is-primary" id="copy-short_url">copy</span><span class="copy-status">&nbsp;</span>
                </div>
                <article class="media" style="visibility: hidden" id="result-card">
                    <figure class="media-left">
                        <p class="image is-64x64">
                            <img src="http://bulma.io/images/placeholders/128x128.png" id="result-image">
                        </p>
                    </figure>
                    <div class="media-content">
                        <div class="content">
                            <p>
                                <strong id="result-title"></strong>
                                <br>
                                <span id="result-description"></span>
                            </p>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
    <div class="columns">
        <div class="column is-three-quarters" id="short_urls">

        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        var pasteTarget = document.querySelector('#long_url');
        pasteTarget.addEventListener('paste', shortenClipboard, false);
        var shortnButtonTarget = document.querySelector('#submit-shorten');
        shortnButtonTarget.addEventListener('click', shortenButton, false);
        var copyButtonTarget = document.querySelector('#copy-short_url');
        copyButtonTarget.addEventListener('click', copyShortUrl, false);

        function shortenButton() {
            var long_url = document.querySelector('#long_url').value;
            shorten(long_url);
        }

        function shortenClipboard(e) {
            var long_url = e.clipboardData.getData('Text');
            shorten(long_url);
        }

        function shorten(long_url) {
            var domainElement = document.querySelector('#domain');
            var domain = domainElement.options[domainElement.selectedIndex].value;
            document.querySelector('div.spinner').setAttribute('style', 'visibility: visible');
            axios.post('/api/v1/shorten', {'domain': domain, 'url': long_url})
                .then(function (response) {
                    console.log('Request succeeded with JSON response', response);
                    document.querySelector('#shorten-error-message').innerText = '';
                    document.querySelector('#short_url').innerText = response.data.short_url;
                    document.querySelector('#result').setAttribute('style', 'visibility: visible');
                    if (response.data.warning !== null) {
                        document.querySelector('#shorten-error-message').innerText = response.data.warning;
                        document.querySelector('#result-card').setAttribute('style', 'visibility: hidden');
                    } else {
                        document.querySelector('#result-title').innerText = response.data.title;
                        document.querySelector('#result-description').innerText = response.data.description;
                        document.querySelector('#result-image').setAttribute('src', response.data.image);
                        document.querySelector('#result-card').setAttribute('style', 'visibility: visible');
                    }
                    document.querySelector('div.spinner').setAttribute('style', 'visibility: hidden');
                })
                .catch(function (error) {
                    console.log(error);
                    document.querySelector('#shorten-error-message').innerText = error.response.data.errors.join();
                    document.querySelector('div.spinner').setAttribute('style', 'visibility: hidden');
                });
        }

        function copyShortUrl() {
            var short_url = document.querySelector('#short_url').innerText;
            var copyResult = copyToClipboard(short_url);
            if (copyResult) {
                document.querySelector('span.copy-status').innerHTML = '&#10004;';
                setTimeout(function () {
                    document.querySelector('span.copy-status').innerHTML = '&nbsp;';
                }, 10000);
            }
        }

        // from http://www.jomendez.com/2017/01/25/copy-clipboard-using-javascript/
        function copyToClipboard(text) {

            if (window.clipboardData && window.clipboardData.setData) {
                // IE specific code path to prevent textarea being shown while dialog is visible.

                return clipboardData.setData("Text", text);

            }

            else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
                var textarea = document.createElement("textarea");
                textarea.textContent = text;
                textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in MS Edge.
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    return document.execCommand("copy"); // Security exception may be thrown by some browsers.
                } catch (ex) {
                    console.warn("Copy to clipboard failed.", ex);
                    return false;
                } finally {
                    document.body.removeChild(textarea);
                }
            }
        }
        var mediaObjTemplate = `
        <div class="box">
          <article class="media">
            <div class="media-left">
              <figure class="image is-64x64">
                <img src="@@image" alt="Image"></a>
              </figure>
            </div>
            <div class="media-content">
              <div class="content">
                <p>
                  <a href="@@long_url"><strong>@@title</strong></a>
                  <br>
                  @@description
                </p>
              </div>
            </div>
          </article>
        </div>
        `

        axios.get('/api/v1/short_urls')
            .then(function (response) {
                var resultsHTML = "<h2>Your short urls</h2>";
                response.data.results.forEach(function(val,index) {
                    resultsHTML += mediaObjTemplate.replace('@@image', val.image)
                        .replace('@@title', val.title)
                        .replace('@@short_url', val.short_url)
                        .replace('@@long_url', val.long_url)
                        .replace('@@description', val.description);
                });
                document.querySelector('#short_urls').innerHTML = resultsHTML;
            })
            .catch(function (error) {
                console.log(error);
                document.querySelector('#short_urls').innerHTML = error.response.data.errors.join();
            });
    </script>
{% endblock %}